/****************************** Module Header ******************************\
* Module Name: nlsxlat.c
*
* Copyright (c) 1985-91, Microsoft Corporation
*
* This modules contains the private routines for character translation:
* 8-bit <=> Unicode.
*
* History:
* 03-Jan-1992    gregoryw
* 16-Feb-1993    JulieB      Added Upcase Routines & Macros.
* 17-Feb-1993    JulieB      Fixed Tables; Fixed DBCS Code.
* 08-Mar-1993    JulieB      Moved Upcase Macro to ntrtlp.h.
\***************************************************************************/

#include "ntrtlp.h"

/*
 * Global data used by the translation routines.
 *
 */

//
// Upcase and Lowercase data
//
const UCHAR Nls844UnicodeCaseTableLevel1[] = {
    0x00,0x10,0x20,0x30,0x40,0x50,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,  // 0x00
    0x70,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x80,0x90,  // 0x10
    0x60,0xa0,0x60,0x60,0xb0,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,  // 0x20
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,  // 0x30
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,  // 0x40
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,  // 0x50
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,  // 0x60
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,  // 0x70
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,  // 0x80
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,  // 0x90
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,  // 0xa0
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,  // 0xb0
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,  // 0xc0
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,  // 0xd0
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,  // 0xe0
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0xc0,  // 0xf0
};

const UCHAR Nls844UnicodeUpcaseTableLevel2[] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x0a,0x91,  // 0x00
    0x95,0x95,0x95,0x99,0x9c,0x95,0x95,0x17,0xa0,0xa4,0xa8,0xac,0xb0,0xb4,0x95,0xb8,  // 0x10
    0x95,0xbb,0x00,0x00,0x00,0xbf,0xc3,0xc7,0xcb,0xcf,0x00,0x00,0x00,0x00,0x00,0x00,  // 0x20
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xd0,0x04,0xd4,0x00,0xd8,0x00,  // 0x30
    0x00,0x00,0x00,0x0a,0x0a,0x47,0x95,0x95,0xdc,0x95,0x95,0x95,0xe0,0x95,0x96,0xe4,  // 0x40
    0x00,0x00,0x00,0x00,0x00,0x00,0x57,0x58,0x5b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // 0x50
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // 0x60
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // 0x70
    0x95,0x95,0x95,0x95,0x95,0x95,0x95,0x95,0x95,0xdb,0x95,0x95,0x95,0x95,0x95,0xda,  // 0x80
    0x6c,0x70,0x6c,0x6c,0x70,0x74,0x6c,0xe8,0x00,0x00,0x00,0xec,0x00,0xec,0xf0,0x00,  // 0x90
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x87,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // 0xa0
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x8d,0xf4,0x00,  // 0xb0
    0x00,0x00,0x00,0x00,0x04,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // 0xc0
};

const UCHAR Nls844UnicodeLowercaseTableLevel2[] = {
    0x00,0x00,0x00,0x00,0x04,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x0a,0x0d,0x00,0x00,  // 0x00
    0x11,0x11,0x11,0x15,0x17,0x11,0x11,0x1a,0x1e,0x22,0x26,0x2a,0x2e,0x31,0x11,0x35,  // 0x10
    0x11,0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // 0x20
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3b,0x04,0x3f,0x00,0x00,0x00,0x43,0x00,  // 0x30
    0x47,0x0a,0x0a,0x00,0x00,0x00,0x11,0x11,0x4b,0x11,0x11,0x11,0x4f,0x11,0x12,0x53,  // 0x40
    0x00,0x00,0x00,0x57,0x58,0x5b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // 0x50
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // 0x60
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x58,0x58,0x5f,0x00,0x00,0x00,  // 0x70
    0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x63,0x11,0x11,0x11,0x11,0x11,0x67,  // 0x80
    0x6a,0x6e,0x6a,0x6a,0x6e,0x72,0x6a,0x00,0x00,0x00,0x00,0x76,0x79,0x7c,0x7f,0x83,  // 0x90
    0x00,0x00,0x00,0x00,0x00,0x00,0x87,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // 0xa0
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x8b,0x8d,0x00,0x00,0x00,  // 0xb0
    0x00,0x00,0x04,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // 0xc0
};

const USHORT Nls844UnicodeCaseTableLevel3[] = {
    0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,  // 0x00
    0x0000,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,  // 0x01
    0x0020,0x0020,0x0020,0x0000,0x0000,0x0000,0x0000,0x0000,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,  // 0x02
    0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0000,0x0020,0x0020,0x0020,0x0020,  // 0x03
    0x0020,0x0020,0x0020,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,  // 0x04
    0x0001,0x0000,0x0001,0x0000,0x0000,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0000,0x0001,0x0000,0x0001,  // 0x05
    0x0000,0x0001,0x0000,0x0001,0x0000,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,  // 0x06
    0xff87,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0000,0x0000,0x00d2,0x0001,0x0000,0x0001,0x0000,0x00ce,0x0001,  // 0x07
    0x0000,0x00cd,0x00cd,0x0001,0x0000,0x0000,0x004f,0x00ca,0x00cb,0x0001,0x0000,0x00cd,0x00cf,0x0000,0x00d3,0x00d1,  // 0x08
    0x0001,0x0000,0x0000,0x0000,0x00d3,0x00d5,0x0000,0x00d6,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0000,0x0001,  // 0x09
    0x0000,0x00da,0x0000,0x0000,0x0001,0x0000,0x00da,0x0001,0x0000,0x00d9,0x00d9,0x0001,0x0000,0x0001,0x0000,0x00db,  // 0x0a
    0x0001,0x0000,0x0000,0x0000,0x0001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0002,0x0000,0x0000,0x0002,  // 0x0b
    0x0000,0x0000,0x0002,0x0000,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,  // 0x0c
    0x0000,0x0000,0x0001,0x0000,0x0000,0x0002,0x0000,0x0000,0x0001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0001,0x0000,  // 0x0d
    0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,  // 0x0e
    0x0000,0x0000,0x0026,0x0000,0x0025,0x0025,0x0025,0x0000,0x0040,0x0000,0x003f,0x003f,0x0020,0x0020,0x0000,0x0020,  // 0x0f
    0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0001,0x0000,  // 0x10
    0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0000,0x0050,0x0050,0x0050,  // 0x11
    0x0050,0x0050,0x0050,0x0050,0x0050,0x0050,0x0050,0x0050,0x0050,0x0000,0x0050,0x0050,0x0001,0x0000,0x0000,0x0000,  // 0x12
    0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0001,0x0000,0x0001,  // 0x13
    0x0000,0x0000,0x0000,0x0001,0x0000,0x0000,0x0000,0x0001,0x0000,0x0000,0x0000,0x0000,0x0001,0x0000,0x0001,0x0000,  // 0x14
    0x0001,0x0000,0x0000,0x0000,0x0001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0030,0x0030,0x0030,  // 0x15
    0x0030,0x0030,0x0030,0x0030,0x0030,0x0030,0x0030,0x0030,0x0030,0x0030,0x0030,0x0030,0x0030,0x0030,0x0030,0x0030,  // 0x16
    0x0030,0x0030,0x0030,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0030,0x0030,0x0030,0x0030,  // 0x17
    0x0030,0x0030,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0001,0x0000,0x0001,0x0000,  // 0x18
    0x0001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0001,0x0000,0x0001,0x0000,  // 0x19
    0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,  // 0x1a
    0xfff8,0xfff8,0xfff8,0xfff8,0xfff8,0xfff8,0xfff8,0xfff8,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,  // 0x1b
    0xfff8,0xfff8,0xfff8,0xfff8,0xfff8,0xfff8,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,  // 0x1c
    0x0000,0xfff8,0x0000,0xfff8,0x0000,0xfff8,0x0000,0xfff8,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,  // 0x1d
    0xfff8,0xfff8,0xffb6,0xffb6,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xffaa,0xffaa,0xffaa,0xffaa,  // 0x1e
    0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xfff8,0xfff8,0xff9c,0xff9c,0x0000,0x0000,0x0000,0x0000,  // 0x1f
    0x0000,0x0000,0x0000,0x0000,0xfff8,0xfff8,0xff90,0xff90,0xfff9,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,  // 0x20
    0x0000,0x0000,0x0000,0x0000,0xff80,0xff80,0xff82,0xff82,0x0000,0x0000,0x0000,0x0000,0x0010,0x0010,0x0010,0x0010,  // 0x21
    0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,0x0000,0x0000,0x0000,0x0000,  // 0x22
    0x0000,0x0000,0x001a,0x001a,0x001a,0x001a,0x001a,0x001a,0x001a,0x001a,0x001a,0x001a,0x001a,0x001a,0x001a,0x001a,  // 0x23
    0x001a,0x001a,0x001a,0x001a,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0000,0x0020,0x0020,0x0020,0x0020,  // 0x24
    0x0020,0x0020,0x0020,0xff87,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,  // 0x25
    0x0000,0x0001,0x0000,0x0001,0x0000,0x0000,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0000,0x0001,0x0000,  // 0x26
    0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,  // 0x27
    0x0000,0x0000,0x0000,0x0001,0x0000,0x0001,0x0000,0x0000,0x0001,0x0000,0x0000,0x0000,0x0001,0x0000,0x0000,0x0000,  // 0x28
    0x0000,0x0000,0x0001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,  // 0x29
    0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0000,0x0001,0x0000,0x0000,0x0000,0x0000,0x0001,0x0000,0x0000,  // 0x2a
    0x0001,0x0000,0x0000,0x0000,0x0001,0x0000,0x0001,0x0000,0x0000,0x0001,0x0000,0x0000,0x0000,0x0001,0x0000,0x0000,  // 0x2b
    0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0002,0x0000,0x0000,0x0002,0x0000,0x0000,0x0002,0x0000,0x0001,0x0000,  // 0x2c
    0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x004f,0x0000,0x0001,  // 0x2d
    0x0000,0x0000,0x0000,0x0002,0x0000,0x0001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,  // 0x2e
    0x0000,0x0001,0x0000,0x0001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x00d2,  // 0x2f
    0x00ce,0x0000,0x00cd,0x00cd,0x0000,0x00ca,0x0000,0x00cb,0x0000,0x0000,0x0000,0x0000,0x00cd,0x0000,0x0000,0x00cf,  // 0x30
    0x0000,0x0000,0x0000,0x0000,0x00d1,0x00d3,0x0000,0x0000,0x0000,0x0000,0x0000,0x00d3,0x0000,0x0000,0x00d5,0x0000,  // 0x31
    0x0000,0x00d6,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x00da,  // 0x32
    0x0000,0x0000,0x0000,0x0000,0x00da,0x0000,0x00d9,0x00d9,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x00db,0x0000,  // 0x33
    0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0026,0x0025,0x0025,0x0025,  // 0x34
    0x0020,0x0020,0x001f,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0040,0x003f,0x003f,0x0000,  // 0x35
    0x0000,0x0000,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,  // 0x36
    0x0000,0x0001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,  // 0x37
    0x0000,0x0000,0x0001,0x0000,0x0001,0x0000,0x0000,0x0000,0x0001,0x0000,0x0000,0x0000,0x0001,0x0000,0x0000,0x0000,  // 0x38
    0x0000,0x0001,0x0000,0x0001,0x0000,0x0001,0x0000,0x0000,0x0000,0x0001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,  // 0x39
    0xffb6,0xffb6,0xffaa,0xffaa,0xffaa,0xffaa,0xff9c,0xff9c,0xff80,0xff80,0xff90,0xff90,0xff82,0xff82,0x0000,0x0000,  // 0x3a
    0xfff8,0xfff8,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,  // 0x3b
    0xfff8,0xfff8,0x0000,0x0000,0x0000,0xfff9,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,  // 0x3c
    0x001a,0x001a,0x001a,0x001a,0x001a,0x001a,0x001a,0x001a,0x001a,0x001a,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,  // 0x3d
};


NTSTATUS
RtlMultiByteToUnicodeN(
    OUT PWCH UnicodeString,
    IN ULONG MaxBytesInUnicodeString,
    OUT PULONG BytesInUnicodeString OPTIONAL,
    IN PCH MultiByteString,
    IN ULONG BytesInMultiByteString)

/*++

Routine Description:

    This functions converts the specified ansi source string into a
    Unicode string. The translation is done with respect to the
    ANSI Code Page (ACP) installed at boot time.  Single byte characters
    in the range 0x00 - 0x7f are simply zero extended as a performance
    enhancement.  In some far eastern code pages 0x5c is defined as the
    Yen sign.  For system translation we always want to consider 0x5c
    to be the backslash character.  We get this for free by zero extending.

    NOTE: This routine only supports precomposed Unicode characters.

Arguments:

    UnicodeString - Returns a unicode string that is equivalent to
        the ansi source string.

    MaxBytesInUnicodeString - Supplies the maximum number of bytes to be
        written to UnicodeString.  If this causes UnicodeString to be a
        truncated equivalent of MultiByteString, no error condition results.

    BytesInUnicodeString - Returns the number of bytes in the returned
        unicode string pointed to by UnicodeString.

    MultiByteString - Supplies the ansi source string that is to be
        converted to unicode.  For single-byte character sets, this address
        CAN be the same as UnicodeString.

    BytesInMultiByteString - The number of bytes in the string pointed to
        by MultiByteString.

Return Value:

    SUCCESS - The conversion was successful.


--*/

{
    ULONG LoopCount;
    ULONG MaxCharsInUnicodeString;

    RTL_PAGED_CODE();

    MaxCharsInUnicodeString = MaxBytesInUnicodeString / sizeof(WCHAR);

    LoopCount = (MaxCharsInUnicodeString < BytesInMultiByteString) ?
                 MaxCharsInUnicodeString : BytesInMultiByteString;

    if (ARGUMENT_PRESENT(BytesInUnicodeString))
        *BytesInUnicodeString = LoopCount * sizeof(WCHAR);

    while (LoopCount) {

        *UnicodeString = (WCHAR)(UCHAR)(*MultiByteString);

        UnicodeString++;
        MultiByteString++;
        LoopCount--;
    }

    return STATUS_SUCCESS;
}


NTSTATUS
RtlMultiByteToUnicodeSize(
    OUT PULONG BytesInUnicodeString,
    IN PCH MultiByteString,
    IN ULONG BytesInMultiByteString)

/*++

Routine Description:

    This functions determines how many bytes would be needed to represent
    the specified ANSI source string in Unicode string (not counting the
    null terminator)
    The translation is done with respect to the ANSI Code Page (ACP) installed
    at boot time.  Single byte characters in the range 0x00 - 0x7f are simply
    zero extended as a performance enhancement.  In some far eastern code pages
    0x5c is defined as the Yen sign.  For system translation we always want to
    consider 0x5c to be the backslash character.  We get this for free by zero
    extending.

    NOTE: This routine only supports precomposed Unicode characters.

Arguments:

    BytesInUnicodeString - Returns the number of bytes a Unicode translation
        of the ANSI string pointed to by MultiByteString would contain.

    MultiByteString - Supplies the ansi source string whose Unicode length
        is to be calculated.

    BytesInMultiByteString - The number of bytes in the string pointed to
        by MultiByteString.

Return Value:

    SUCCESS - The conversion was successful


--*/

{
    RTL_PAGED_CODE();

    *BytesInUnicodeString = BytesInMultiByteString * sizeof(WCHAR);

    return STATUS_SUCCESS;
}


NTSTATUS
RtlUnicodeToMultiByteSize(
    OUT PULONG BytesInMultiByteString,
    IN PWCH UnicodeString,
    IN ULONG BytesInUnicodeString)

/*++

Routine Description:

    This functions determines how many bytes would be needed to represent
    the specified Unicode source string as an ANSI string (not counting the
    null terminator)

Arguments:

    BytesInMultiByteString - Returns the number of bytes an ANSI translation
        of the Unicode string pointed to by UnicodeString would contain.

    UnicodeString - Supplies the unicode source string whose ANSI length
        is to be calculated.

    BytesInUnicodeString - The number of bytes in the the string pointed to by
        UnicodeString.

Return Value:

    SUCCESS - The conversion was successful

    !SUCCESS - The conversion failed.  A unicode character was encountered
        that has no translation for the current ANSI Code Page (ACP).

--*/

{
    RTL_PAGED_CODE();

    *BytesInMultiByteString = BytesInUnicodeString / sizeof(WCHAR);

    return STATUS_SUCCESS;
}


NTSTATUS
RtlUnicodeToMultiByteN(
    OUT PCH MultiByteString,
    IN ULONG MaxBytesInMultiByteString,
    OUT PULONG BytesInMultiByteString OPTIONAL,
    IN PWCH UnicodeString,
    IN ULONG BytesInUnicodeString)

/*++

Routine Description:

    This functions converts the specified unicode source string into an
    ansi string. The translation is done with respect to the
    ANSI Code Page (ACP) loaded at boot time.

Arguments:

    MultiByteString - Returns an ansi string that is equivalent to the
        unicode source string.  If the translation can not be done,
        an error is returned.

    MaxBytesInMultiByteString - Supplies the maximum number of bytes to be
        written to MultiByteString.  If this causes MultiByteString to be a
        truncated equivalent of UnicodeString, no error condition results.

    BytesInMultiByteString - Returns the number of bytes in the returned
        ansi string pointed to by MultiByteString.

    UnicodeString - Supplies the unicode source string that is to be
        converted to ansi.

    BytesInUnicodeString - The number of bytes in the the string pointed to by
        UnicodeString.

Return Value:

    SUCCESS - The conversion was successful

--*/

{
    ULONG LoopCount;
    ULONG CharsInUnicodeString;

    RTL_PAGED_CODE();

    CharsInUnicodeString = BytesInUnicodeString / sizeof(WCHAR);

    LoopCount = (CharsInUnicodeString < MaxBytesInMultiByteString) ?
                 CharsInUnicodeString : MaxBytesInMultiByteString;

    if (ARGUMENT_PRESENT(BytesInMultiByteString))
        *BytesInMultiByteString = LoopCount;

    while (LoopCount) {

        *MultiByteString = (*UnicodeString < 256) ? (UCHAR)*UnicodeString : '?';

        UnicodeString++;
        MultiByteString++;
        LoopCount--;
    }

    return STATUS_SUCCESS;
}


NTSTATUS
RtlUpcaseUnicodeToMultiByteN(
    OUT PCH MultiByteString,
    IN ULONG MaxBytesInMultiByteString,
    OUT PULONG BytesInMultiByteString OPTIONAL,
    IN PWCH UnicodeString,
    IN ULONG BytesInUnicodeString)

/*++

Routine Description:

    This functions upper cases the specified unicode source string and
    converts it into an ansi string. The translation is done with respect
    to the ANSI Code Page (ACP) loaded at boot time.

Arguments:

    MultiByteString - Returns an ansi string that is equivalent to the
        upper case of the unicode source string.  If the translation can
        not be done, an error is returned.

    MaxBytesInMultiByteString - Supplies the maximum number of bytes to be
        written to MultiByteString.  If this causes MultiByteString to be a
        truncated equivalent of UnicodeString, no error condition results.

    BytesInMultiByteString - Returns the number of bytes in the returned
        ansi string pointed to by MultiByteString.

    UnicodeString - Supplies the unicode source string that is to be
        converted to ansi.

    BytesInUnicodeString - The number of bytes in the the string pointed to by
        UnicodeString.

Return Value:

    SUCCESS - The conversion was successful

--*/

{
    ULONG LoopCount;
    ULONG CharsInUnicodeString;
    WCHAR UnicodeChar;

    RTL_PAGED_CODE();

    CharsInUnicodeString = BytesInUnicodeString / sizeof(WCHAR);

    LoopCount = (CharsInUnicodeString < MaxBytesInMultiByteString) ?
                 CharsInUnicodeString : MaxBytesInMultiByteString;

    if (ARGUMENT_PRESENT(BytesInMultiByteString))
        *BytesInMultiByteString = LoopCount;

    while (LoopCount) {

        //
        // Convert to ANSI and back to Unicode before upper casing
        // to ensure the visual best fits are converted and
        // upper cased properly.
        //
        UnicodeChar = (*UnicodeString < 256) ? *UnicodeString : L'?';
        UnicodeChar = NLS_UPCASE(UnicodeChar);

        *MultiByteString = (UnicodeChar < 256) ? (UCHAR)UnicodeChar : '?';

        UnicodeString++;
        MultiByteString++;
        LoopCount--;
    }

    return STATUS_SUCCESS;
}
